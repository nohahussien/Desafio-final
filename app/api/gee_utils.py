import gee_utils
import ee
from datetime import datetime, timedelta

# --------------------------------------------------
# CONFIGURACIÓN
# --------------------------------------------------
GOOGLE_CLOUD_PROJECT = 'desafio-tripulaciones-484914'
DRIVE_FOLDER = 'GEE_EXPORTS_DIARIOS'
NOMBRE_BASE = 'indices_fincas'

MIS_FINCAS = {
    "Field 1_2": "POLYGON((-72.60537242850114 -37.216194509829975,-72.60463428471121 -37.2192156098624,-72.60284900612896 -37.220596252953385,-72.59610271480051 -37.220596252953385,-72.59459209415944 -37.2187918426762,-72.60537242850114 -37.216194509829975))",
    "Field 1_3": "POLYGON((-72.59460925951134 -37.21888753217828,-72.59593105159001 -37.220555245153534,-72.59157085366313 -37.22065093148001,-72.59141635947162 -37.21958469519948,-72.59460925951134 -37.21888753217828))",
    "Field 1_1": "POLYGON((-72.62334537427523 -37.216358554497994,-72.61826419777935 -37.216385895875796,-72.61831569671631 -37.21909258091111,-72.62343120496371 -37.21894221173495,-72.62334537427523 -37.216358554497994))",
    "Field 1_5": "MULTIPOLYGON(((-72.61253929059602 -37.213692783648334,-72.60550117414095 -37.21618083952482,-72.60469436645508 -37.21929762887798,-72.60539508183416 -37.219288977710505,-72.60912322919467 -37.21924294926606,-72.61253929059602 -37.213692783648334)),((-72.60919189400738 -37.21950267607887,-72.60538101196289 -37.21946166674586,-72.60498619027203 -37.22130706935194,-72.60302925031283 -37.220883314436975,-72.60323524475099 -37.22209989502029,-72.60890007019043 -37.222236588276736,-72.60919189400738 -37.21950267607887)))",
    "Field 1_6": "POLYGON((-72.6324348449707 -37.218245043192915,-72.62779998779297 -37.218491103607334,-72.62599754333496 -37.22155312066438,-72.63411712633388 -37.221484773447806,-72.6324348449707 -37.218245043192915))",
    "Field 1_7": "POLYGON((-72.63664054831315 -37.21426695768697,-72.63915538774744 -37.21672081865802,-72.63698387132898 -37.218716658034424,-72.63471794089128 -37.217076246110956,-72.63664054831315 -37.21426695768697))",
    "Granja 1_7": "POLYGON((-73.22854614257812 -40.34087892439068,-73.22743034362793 -40.345471302889614,-73.23168754499055 -40.34591613225603,-73.23258018493651 -40.34121911134347,-73.22854614257812 -40.34087892439068))",
    "Granja 1_8": "POLYGON((-73.22830581586457 -40.340878924490504,-73.2240657803777 -40.34052565156049,-73.22288131687674 -40.34514422084822,-73.22724151611328 -40.34539280361982,-73.22830581586457 -40.340878924490504))",
    "Granja 1_9": "POLYGON((-73.24011611833703 -40.348297226938264,-73.23534393153386 -40.348244895895185,-73.23517227015691 -40.352771363506555,-73.24028777971398 -40.35224808796117,-73.24011611833703 -40.348297226938264))",
    "Granja 1_10": "POLYGON((-59.46157836835482 -36.32762826593765,-59.46671104444249 -36.331887719739726,-59.464118957257604 -36.333796100714345,-59.45883178632357 -36.32957823996245,-59.46157836835482 -36.32762826593765))",
    "Granja 1_11": "POLYGON((-59.46223926537642 -36.333747700639215,-59.46025657627616 -36.33510290013266,-59.456368446481065 -36.3320467535325,-59.45856571171317 -36.33056012287952,-59.46223926537642 -36.333747700639215))",
    "Granja 1_12": "POLYGON((-59.45827388743781 -36.330414915530376,-59.45622253417967 -36.33188080591633,-59.452634811270414 -36.328817617408895,-59.45504665348564 -36.32733784017259,-59.45827388743781 -36.330414915530376))",
    "Granja 1_13": "POLYGON((-59.46116638157401 -36.327324010319614,-59.458711623359704 -36.32923250308041,-59.4541454309947 -36.32505588612837,-59.45702934265138 -36.323423901434445,-59.46116638157401 -36.327324010319614))",
    "Granja 1_14": "POLYGON((-54.083633421279956 -34.42582907405228,-54.08624267630512 -34.42908572692301,-54.08105850062565 -34.431832544851225,-54.07886123709614 -34.42815122218392,-54.083633421279956 -34.42582907405228))",
    "Granja 1_15": "POLYGON((-54.08086967494455 -34.43181838644455,-54.07630348126985 -34.43382888696835,-54.07311057992047 -34.42929811376595,-54.07800292942558 -34.427698125408675,-54.08086967494455 -34.43181838644455))"
}

# --------------------------------------------------
# FUNCIONES
# --------------------------------------------------
def obtener_fechas_recientes():
    """
    Ventana de los últimos 2 días para asegurar disponibilidad de Sentinel-2.
    """
    hoy = datetime.now()
    inicio = hoy - timedelta(days=2)
    return inicio.strftime('%Y-%m-%d'), hoy.strftime('%Y-%m-%d')


def main():
    # 1. Inicializar GEE
    gee_utils.initialize_gee(GOOGLE_CLOUD_PROJECT)

    # 2. Fechas
    start_date, end_date = obtener_fechas_recientes()
    print("\n--- INICIANDO PROCESO DIARIO ---")
    print(f"Buscando imágenes entre {start_date} y {end_date}")

    # 3. Geometrías
    fincas_fc = gee_utils.wkt_dict_to_fc(MIS_FINCAS)

    # 4. Sentinel-2
    s2_collection = gee_utils.get_sentinel2_collection(start_date, end_date)
    cantidad = s2_collection.size().getInfo()

    if cantidad == 0:
        print("RESULTADO: No hay imágenes disponibles en las últimas 48h.")
        return

    print(f"Se encontraron {cantidad} imágenes. Procesando...")

    # 5. Extracción
    tabla_resultados = gee_utils.extract_data(s2_collection, fincas_fc)

    if tabla_resultados.size().getInfo() == 0:
        print("Las imágenes no intersectan las fincas.")
        return

    # 6. Exportación
    nombre_archivo = f"{NOMBRE_BASE}_{end_date}"

    gee_utils.export_to_drive_and_monitor(
        collection=tabla_resultados,
        description=f'Extraccion_Diaria_{end_date}',
        folder=DRIVE_FOLDER,
        filename=nombre_archivo
    )


if __name__ == "__main__":
    main()